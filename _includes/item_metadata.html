<table class="metadata-block">
  <tbody>

  {% comment %}
    Populate variables for the concatenated fields
  {% endcomment %}

  {% if page.width_cm %}
    {% if page.height_cm %}
      {%- capture dimensions -%} 
        {{ page.width_cm }} cm x {{ page.height_cm }} cm
      {%- endcapture -%} 
    {% endif %}
  {% endif %}

  {% if page.location_city or page.location_country %}
    {%- capture location_url -%}
      /{{ page.collection }}/locations/{{ page.location_city | slugify }}
    {%- endcapture -%}
    {%- capture location_info -%}   
        {% if page.location_city %}<a href="{{ location_url | absolute_url }}/">{{ page.location_city }}</a>{% endif %}{% if page.location_country %}, {{ page.location_country }}</a>{% endif %}
    {%- endcapture -%}
  {% endif %}

  {% if page.location_collection %}
    {%- capture collection_info -%}
      {% if page.location_collection %}{{ page.location_collection }}, {% endif %}
        {% if page.public_collection_info %}{{ page.public_collection_info }}{% endif %}
    {%- endcapture -%}
  {% endif %}

  {% comment %}
    Loop through the metadata object
  {% endcomment %}

  {% for item in include.meta %}
    {% if item.value contains 'page.' %}
      {% assign key = item.value | remove: 'page.' %}
      {% assign value = page[key] %}
    {% else %}
      {% assign value = item.value %}
    {% endif %}

    {% comment %}
      Populate the tabbed metadata array
    {% endcomment %}

    {% comment %}
      Set non-displaying fields to nil
    {% endcomment %}

    {% case key %}
      {% when "bibliography", "exhibition_history", "copies_and_variants", "provenance", "related_works", "curatorial_files", "discussion" %}
        {% assign value = nil %}
      {% when "dimensions" %}
        {% assign value = dimensions %}
      {% when "location_info" %}
        {% if location_info | strip != "" %}
          {% assign value = location_info | strip %}
        {% endif %}
      {% when "collection_info" %}
        {% if collection_info | strip != "" %}
          {% assign value = collection_info | strip %}
        {% endif %}
    {% endcase %}

    {% comment %}
      Only display non-empty values
    {% endcomment %}

    {% if value | strip != '' %}

      {% if item.type == 'link' %}
        {% if key == 'manifest' %}
          {%- capture value -%}
            <a href="{{ value | absolute_url }}" target="_blank" rel="noreferrer">{{ value | absolute_url }}</a>
          {%- endcapture -%}
        {% else %}
          {%- capture value -%}
            <a href="{{ value | absolute_url }}" target="_blank" rel="noreferrer">
              {{ value | absolute_url | remove: 'https://' | remove: 'http://' | split: "/" | first }}
            </a>
          {%- endcapture -%}
        {% endif %}
      {% endif %}

      {% if key == 'worktags' %}
        {% assign parsed_worktags = value | split: "|" }
        {% assign worktaglist_html = "" %}
          {% for worktag in parsed_worktags %}
            {%- capture worktag_url -%}
              /{{ page.collection }}/tags/{{ worktag | slugify }}
            {%- endcapture -%}
            {%- capture worktag_html -%}
              <a href="{{ worktag_url | absolute_url }}/">{{ worktag }}</a>
              {% unless forloop.last %}, {% endunless %}
              {%- endcapture -%}
            {% assign worktaglist_html = worktaglist_html | append: worktag_html %}
          {% endfor %}
        {% assign value = worktaglist_html %}
      {% endif %}

      {% if key == 'other_attribution_authorities' or 'medium' %}
        {% assign value = value | replace: "|", "<br />" %}
      {% endif %}

      {% if key == 'genre' %}
        {%- capture genre_url -%}  
          /{{ page.collection }}/genres/{{ page.genre | slugify }}
        {%- endcapture -%}
        {%- capture value -%}
          <a href="{{ genre_url | absolute_url }}/">{{ page.genre }}</a>
        {%- endcapture -%}
      {% endif %}

      {% if key == 'object_type' %}
        {%- capture object_url -%}
          /{{ page.collection }}/object-types/{{ page.object_type | slugify }}
        {%- endcapture -%}
        {%- capture value -%}
          <a href="{{ object_url | absolute_url }}/">{{ page.object_type }}</a>
        {%- endcapture -%}
      {% endif %}

      {% if key == 'diameter_cm' %}
        {% assign value = value | append: " cm" %}
      {% endif %}

      {% if key == 'collaborators' or key == 'collectors_patrons' %}
        {% assign personArray = value | split: "|" %}
        {% assign bioString = "" %}
          {% for person in personArray %}
            {% assign stripped = person | strip %}
            {% assign bio = site.biographies | where: "label", stripped %}
            {% assign bio_url = "/biographies/" | append: bio[0].pid %}
            {%- capture biolink -%}
              <a href="{{ bio_url | absolute_url }}">{{ bio[0].label }}</a>
              {% unless forloop.last %}, {% endunless %}
            {%- endcapture -%}
            {% assign bioString = bioString | append: biolink %}
          {% endfor %}
          {% assign value = bioString %}
      {% endif %}
      <tr>
        <td class="label">{{ item.label }}</td>
        <td class="value">{{ value | strip }}</td>
      </tr>
    {% endif %}
  {% endfor %}
  </tbody>
</table>